<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1920, height=1080">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 1920px;
      height: 1080px;
      overflow: hidden;
      background: transparent;
    }
    #template-mount {
      width: 1920px;
      height: 1080px;
      position: relative;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div id="template-mount"></div>
  <script>
    /**
     * Transparent host page for offscreen template rendering.
     * Templates are injected via executeJavaScript from the main process.
     *
     * Message buffering: commands sent before the iframe finishes loading
     * are queued and flushed once the iframe's onload fires.
     */

    var __iframeReady = false;
    var __pendingMessages = [];
    var __currentIframe = null;

    function __sendToIframe(msg) {
      if (__iframeReady && __currentIframe && __currentIframe.contentWindow) {
        __currentIframe.contentWindow.postMessage(msg, '*');
      } else {
        __pendingMessages.push(msg);
      }
    }

    function __flushPending() {
      __iframeReady = true;
      for (var i = 0; i < __pendingMessages.length; i++) {
        if (__currentIframe && __currentIframe.contentWindow) {
          __currentIframe.contentWindow.postMessage(__pendingMessages[i], '*');
        }
      }
      __pendingMessages = [];
    }

    // IPC bridge functions (called from main process via executeJavaScript)
    window.__loadTemplate = function(payload) {
      var mount = document.getElementById('template-mount');
      if (payload.templateHtml) {
        // Reset state
        __iframeReady = false;
        __pendingMessages = [];
        __currentIframe = null;

        mount.innerHTML = '';
        var iframe = document.createElement('iframe');
        iframe.style.cssText = 'width:1920px;height:1080px;border:none;background:transparent;';
        iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin');
        __currentIframe = iframe;

        iframe.onload = function() {
          __flushPending();
        };

        mount.appendChild(iframe);
        iframe.srcdoc = payload.templateHtml;

        // Queue field update so variables are applied once iframe loads
        if (payload.variables && Object.keys(payload.variables).length > 0) {
          __sendToIframe({ type: 'updateGraphics', fields: payload.variables });
        }
      }
    };

    window.__updateFields = function(fields) {
      __sendToIframe({ type: 'updateGraphics', fields: fields });
    };

    window.__play = function() {
      __sendToIframe({ type: 'play' });
    };

    window.__stop = function() {
      __sendToIframe({ type: 'stop' });
    };

    window.__next = function() {
      __sendToIframe({ type: 'next' });
    };

    window.__clear = function() {
      __iframeReady = false;
      __pendingMessages = [];
      __currentIframe = null;
      var mount = document.getElementById('template-mount');
      mount.innerHTML = '';
    };
  </script>
</body>
</html>
